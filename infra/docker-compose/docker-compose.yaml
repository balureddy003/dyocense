version: "3.9"

services:
  keycloak:
    image: quay.io/keycloak/keycloak:25.0.2
    command: ["start-dev", "--http-port=8080"]
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
    ports:
      - "8080:8080"

  mongo:
    image: mongo:7.0
    environment:
      MONGO_INITDB_ROOT_USERNAME: dyocense
      MONGO_INITDB_ROOT_PASSWORD: dyocenseDev123
    ports:
      - "27017:27017"
    volumes:
      - mongo-data:/data/db

  neo4j:
    image: neo4j:5.22
    environment:
      NEO4J_AUTH: neo4j/neo4j123
    ports:
      - "7474:7474"
      - "7687:7687"
    volumes:
      - neo4j-data:/data
      - neo4j-logs:/logs

  minio:
    image: minio/minio:RELEASE.2024-09-22T00-33-43Z
    command: ["server", "/data", "--console-address", ":9001"]
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio-data:/data

  qdrant:
    image: qdrant/qdrant:v1.11.5
    environment:
      QDRANT__SERVICE__GRPC_PORT: 6334
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant-storage:/qdrant/storage

  postgres-metadata:
    build:
      context: ../..
      dockerfile: infra/docker-compose/postgres-pgvector.Dockerfile
    image: dyocense/postgres-pgvector:local
    environment:
      POSTGRES_USER: metadata
      POSTGRES_PASSWORD: metadataPass123
      POSTGRES_DB: metadata
    ports:
      - "5432:5432"
    volumes:
      - postgres-metadata-data:/var/lib/postgresql/data

  nessie:
    image: projectnessie/nessie:0.74.0
    environment:
      NESSIE_VERSION_STORE_TYPE: ROCKSDB
      NESSIE_AUTH_ENABLED: "false"
    ports:
      - "19120:19120"
    depends_on:
      - postgres-metadata

  nats:
    image: nats:2.10
    command: ["--js"]
    ports:
      - "4222:4222"

  kernel-api:
    build:
      context: ../..
      dockerfile: infra/docker-compose/kernel.Dockerfile
    environment:
      MONGO_URI: mongodb://dyocense:dyocenseDev123@mongo:27017
      NATS_URL: nats://nats:4222
      POLICY_API_URL: http://kernel-api:8001
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4317
      ALLOW_ANONYMOUS: "true"
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: neo4j123
      MINIO_ENDPOINT: http://minio:9000
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
    depends_on:
      - mongo
      - nats
      - neo4j
      - minio
    ports:
      - "8001:8001"

  orchestrator:
    build:
      context: ../..
      dockerfile: infra/docker-compose/kernel.Dockerfile
    environment:
      ALLOW_ANONYMOUS: "true"
      KERNEL_API_URL: http://kernel-api:8001
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: neo4j123
      MINIO_ENDPOINT: http://minio:9000
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
    depends_on:
      - kernel-api
    ports:
      - "8010:8010"
    command: ["uvicorn", "services.orchestrator.main:app", "--host", "0.0.0.0", "--port", "8010"]

volumes:
  mongo-data: {}
  neo4j-data: {}
  neo4j-logs: {}
  minio-data: {}
  qdrant-storage: {}
  postgres-metadata-data: {}
