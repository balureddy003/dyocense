# =====================================================================
# PostgreSQL Exporter Custom Queries
# =====================================================================
# Purpose: Extended metrics for Dyocense-specific monitoring
# Documentation: https://github.com/prometheus-community/postgres_exporter
# =====================================================================

# Database size metrics
pg_database_size:
  query: "SELECT datname, pg_database_size(datname) as size_bytes FROM pg_database WHERE datname = current_database()"
  master: true
  metrics:
    - datname:
        usage: "LABEL"
        description: "Database name"
    - size_bytes:
        usage: "GAUGE"
        description: "Database size in bytes"

# Table sizes for key tables
pg_table_sizes:
  query: |
    SELECT
      schemaname,
      tablename,
      pg_total_relation_size(schemaname||'.'||tablename) as total_bytes,
      pg_relation_size(schemaname||'.'||tablename) as table_bytes,
      pg_indexes_size(schemaname||'.'||tablename) as index_bytes
    FROM pg_tables
    WHERE schemaname NOT IN ('pg_catalog', 'information_schema')
    ORDER BY total_bytes DESC
    LIMIT 20
  master: true
  metrics:
    - schemaname:
        usage: "LABEL"
        description: "Schema name"
    - tablename:
        usage: "LABEL"
        description: "Table name"
    - total_bytes:
        usage: "GAUGE"
        description: "Total size including indexes and TOAST"
    - table_bytes:
        usage: "GAUGE"
        description: "Table size excluding indexes"
    - index_bytes:
        usage: "GAUGE"
        description: "Indexes size"

# Connection pool metrics
pg_connection_pool:
  query: |
    SELECT
      state,
      COUNT(*) as connections
    FROM pg_stat_activity
    WHERE datname = current_database()
    GROUP BY state
  metrics:
    - state:
        usage: "LABEL"
        description: "Connection state"
    - connections:
        usage: "GAUGE"
        description: "Number of connections in this state"

# Long-running queries
pg_long_running_queries:
  query: |
    SELECT
      COUNT(*) as count,
      MAX(EXTRACT(EPOCH FROM (NOW() - query_start))) as max_duration_seconds
    FROM pg_stat_activity
    WHERE state = 'active'
      AND query NOT LIKE '%pg_stat_activity%'
      AND query_start < NOW() - INTERVAL '30 seconds'
  metrics:
    - count:
        usage: "GAUGE"
        description: "Number of queries running longer than 30 seconds"
    - max_duration_seconds:
        usage: "GAUGE"
        description: "Maximum query duration in seconds"

# Replication lag (if using replication)
pg_replication_lag:
  query: |
    SELECT
      COALESCE(EXTRACT(EPOCH FROM (NOW() - pg_last_xact_replay_timestamp())), 0) as lag_seconds
  metrics:
    - lag_seconds:
        usage: "GAUGE"
        description: "Replication lag in seconds"

# Index usage statistics
pg_index_usage:
  query: |
    SELECT
      schemaname,
      tablename,
      indexname,
      idx_scan,
      idx_tup_read,
      idx_tup_fetch
    FROM pg_stat_user_indexes
    WHERE schemaname NOT IN ('pg_catalog', 'information_schema')
    ORDER BY idx_scan DESC
    LIMIT 20
  master: true
  metrics:
    - schemaname:
        usage: "LABEL"
        description: "Schema name"
    - tablename:
        usage: "LABEL"
        description: "Table name"
    - indexname:
        usage: "LABEL"
        description: "Index name"
    - idx_scan:
        usage: "COUNTER"
        description: "Number of index scans"
    - idx_tup_read:
        usage: "COUNTER"
        description: "Number of index tuples read"
    - idx_tup_fetch:
        usage: "COUNTER"
        description: "Number of index tuples fetched"

# Cache hit ratio
pg_cache_hit_ratio:
  query: |
    SELECT
      'heap_read' as metric,
      SUM(heap_blks_hit) / NULLIF(SUM(heap_blks_hit + heap_blks_read), 0) as ratio
    FROM pg_statio_user_tables
    UNION ALL
    SELECT
      'index_read' as metric,
      SUM(idx_blks_hit) / NULLIF(SUM(idx_blks_hit + idx_blks_read), 0) as ratio
    FROM pg_statio_user_indexes
  metrics:
    - metric:
        usage: "LABEL"
        description: "Type of cache metric"
    - ratio:
        usage: "GAUGE"
        description: "Cache hit ratio (0-1)"

# Bloat estimation for tables
pg_table_bloat:
  query: |
    SELECT
      schemaname,
      tablename,
      ROUND(CASE WHEN otta=0 OR sml.relpages=0 THEN 0.0
        ELSE sml.relpages/otta::numeric END,1) AS bloat_ratio
    FROM (
      SELECT
        schemaname, tablename, cc.reltuples, cc.relpages, bs,
        CEIL((cc.reltuples*((datahdr+ma-
          (CASE WHEN datahdr%ma=0 THEN ma ELSE datahdr%ma END))+nullhdr2+4))/(bs-20::float)) AS otta
      FROM (
        SELECT
          ma,bs,schemaname,tablename,
          (datawidth+(hdr+ma-(case when hdr%ma=0 THEN ma ELSE hdr%ma END)))::numeric AS datahdr,
          (maxfracsum*(nullhdr+ma-(case when nullhdr%ma=0 THEN ma ELSE nullhdr%ma END))) AS nullhdr2
        FROM (
          SELECT
            schemaname, tablename, hdr, ma, bs,
            SUM((1-null_frac)*avg_width) AS datawidth,
            MAX(null_frac) AS maxfracsum,
            hdr+(
              SELECT 1+count(*)/8
              FROM pg_stats s2
              WHERE null_frac<>0 AND s2.schemaname = s.schemaname AND s2.tablename = s.tablename
            ) AS nullhdr
          FROM pg_stats s, (
            SELECT
              (SELECT current_setting('block_size')::numeric) AS bs,
              CASE WHEN substring(v,12,3) IN ('8.0','8.1','8.2') THEN 27 ELSE 23 END AS hdr,
              CASE WHEN v ~ 'mingw32' THEN 8 ELSE 4 END AS ma
            FROM (SELECT version() AS v) AS foo
          ) AS constants
          GROUP BY 1,2,3,4,5
        ) AS foo
      ) AS rs
      JOIN pg_class cc ON cc.relname = rs.tablename
      JOIN pg_namespace nn ON cc.relnamespace = nn.oid AND nn.nspname = rs.schemaname
    ) AS sml
    WHERE schemaname NOT IN ('pg_catalog', 'information_schema')
      AND sml.relpages > 0
    ORDER BY bloat_ratio DESC
    LIMIT 10
  master: true
  metrics:
    - schemaname:
        usage: "LABEL"
        description: "Schema name"
    - tablename:
        usage: "LABEL"
        description: "Table name"
    - bloat_ratio:
        usage: "GAUGE"
        description: "Table bloat ratio (1.0 = no bloat, >1.0 = bloated)"
