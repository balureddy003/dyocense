# =====================================================================
# PostgreSQL Configuration for Dyocense v4.0
# =====================================================================
# Purpose: Production-grade settings for TimescaleDB + pgvector
# Image: timescale/timescaledb-ha:pg16
# Target: 2-4 CPU, 4-8GB RAM
# =====================================================================

# =============================================================================
# CONNECTIONS AND AUTHENTICATION
# =============================================================================

max_connections = 200
superuser_reserved_connections = 3

# Connection settings
listen_addresses = '*'
port = 5432

# Authentication
password_encryption = scram-sha-256

# =============================================================================
# RESOURCE USAGE (Optimized for 4GB RAM, 2-4 CPUs)
# =============================================================================

# Memory settings (auto-tuned by timescaledb-tune)
shared_buffers = 1GB
effective_cache_size = 3GB
maintenance_work_mem = 256MB
work_mem = 10MB

# Parallel query settings
max_worker_processes = 8
max_parallel_workers_per_gather = 2
max_parallel_workers = 4
max_parallel_maintenance_workers = 2

# Background workers
max_wal_senders = 10
max_replication_slots = 10

# =============================================================================
# WRITE-AHEAD LOG (WAL)
# =============================================================================

wal_level = replica
wal_compression = on
wal_buffers = 16MB
min_wal_size = 1GB
max_wal_size = 4GB

# Checkpoints
checkpoint_timeout = 10min
checkpoint_completion_target = 0.9
checkpoint_warning = 30s

# Archive mode (for backups)
archive_mode = on
archive_command = '/bin/true'  # Replace with actual backup command

# =============================================================================
# QUERY TUNING
# =============================================================================

# Cost-based query planner
random_page_cost = 1.1  # Optimized for SSD
effective_io_concurrency = 200
seq_page_cost = 1.0

# Query planning
default_statistics_target = 100
constraint_exclusion = partition
cpu_tuple_cost = 0.01
cpu_index_tuple_cost = 0.005
cpu_operator_cost = 0.0025

# =============================================================================
# LOGGING
# =============================================================================

logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_truncate_on_rotation = on

# What to log
log_min_duration_statement = 1000  # Log queries slower than 1s
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_temp_files = 0
log_autovacuum_min_duration = 0
log_error_verbosity = default

# Statement logging
log_statement = 'none'  # Change to 'ddl' or 'all' for debugging
log_duration = off

# =============================================================================
# AUTOVACUUM
# =============================================================================

autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 20s

# Aggressive autovacuum for high-traffic tables
autovacuum_vacuum_threshold = 50
autovacuum_vacuum_scale_factor = 0.02
autovacuum_analyze_threshold = 50
autovacuum_analyze_scale_factor = 0.01

# Autovacuum cost delays (reduce I/O impact)
autovacuum_vacuum_cost_delay = 2ms
autovacuum_vacuum_cost_limit = 200

# =============================================================================
# CLIENT CONNECTION DEFAULTS
# =============================================================================

# Statement behavior
statement_timeout = 300000  # 5 minutes
lock_timeout = 30000  # 30 seconds
idle_in_transaction_session_timeout = 300000  # 5 minutes

# Locale and formatting
datestyle = 'iso, mdy'
timezone = 'UTC'
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'
default_text_search_config = 'pg_catalog.english'

# =============================================================================
# SHARED PRELOAD LIBRARIES
# =============================================================================

shared_preload_libraries = 'timescaledb,pg_stat_statements'
# Add 'pg_cron' when installed: shared_preload_libraries = 'timescaledb,pg_stat_statements,pg_cron'

# =============================================================================
# TIMESCALEDB SETTINGS
# =============================================================================

timescaledb.telemetry_level = off
timescaledb.max_background_workers = 8

# Compression settings
timescaledb.compress_segmentby = ''
timescaledb.compress_orderby = ''

# =============================================================================
# PG_STAT_STATEMENTS (Query Performance Tracking)
# =============================================================================

pg_stat_statements.max = 10000
pg_stat_statements.track = all
pg_stat_statements.track_utility = on
pg_stat_statements.save = on

# =============================================================================
# PGVECTOR SETTINGS
# =============================================================================

# HNSW index settings (tuned for 1536-dim embeddings)
# Default values are usually sufficient
# hnsw.ef_search = 40  # Runtime search quality

# =============================================================================
# SECURITY
# =============================================================================

# SSL (enable in production)
# ssl = on
# ssl_cert_file = '/etc/ssl/certs/server.crt'
# ssl_key_file = '/etc/ssl/private/server.key'
# ssl_ca_file = '/etc/ssl/certs/ca.crt'
# ssl_prefer_server_ciphers = on
# ssl_ciphers = 'HIGH:MEDIUM:+3DES:!aNULL'

# Row-Level Security
row_security = on

# =============================================================================
# REPLICATION (for high availability)
# =============================================================================

# Hot standby
hot_standby = on
hot_standby_feedback = on
max_standby_streaming_delay = 30s

# Replication
synchronous_commit = on
wal_receiver_timeout = 60s
wal_retrieve_retry_interval = 5s

# =============================================================================
# CUSTOM SETTINGS FOR DYOCENSE
# =============================================================================

# Increase JSONB processing
# (already optimized by work_mem and shared_buffers)

# Track I/O timing
track_io_timing = on
track_functions = all
track_activity_query_size = 4096

# =============================================================================
# PERFORMANCE MONITORING
# =============================================================================

shared_preload_libraries = 'timescaledb,pg_stat_statements'
compute_query_id = on
log_executor_stats = off
log_planner_stats = off
log_parser_stats = off
log_statement_stats = off

# =============================================================================
# JIT (Just-In-Time Compilation)
# =============================================================================

jit = on
jit_above_cost = 100000
jit_inline_above_cost = 500000
jit_optimize_above_cost = 500000
