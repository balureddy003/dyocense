# =====================================================================
# Dyocense SMB Deployment - Environment Configuration
# =====================================================================
# Copy this file to .env and update with your values
# =====================================================================

# ---------------------------------------------------------------------
# Deployment Mode
# ---------------------------------------------------------------------
DEPLOYMENT_MODE=unified
PERSISTENCE_BACKEND=postgres
USE_MONGODB=false
ENABLE_PGVECTOR=true
PGVECTOR_COLLECTION=embeddings

# ---------------------------------------------------------------------
# PostgreSQL Configuration
# ---------------------------------------------------------------------
POSTGRES_URL="postgresql://metadata:metadataPass123@localhost:5432/metadata"
POSTGRES_HOST=localhost
# For LOCAL (non-Docker) development, change POSTGRES_HOST to "localhost".
# Keeping it as "postgres" is correct only when using docker-compose.smb.yml.
POSTGRES_PORT=5432
POSTGRES_DB=metadata
POSTGRES_USER=metadata
POSTGRES_PASSWORD=metadataPass123
POSTGRES_MIN_POOL_SIZE=2
POSTGRES_MAX_POOL_SIZE=10

# ---------------------------------------------------------------------
# MongoDB Configuration (only if using mongodb backend)
# ---------------------------------------------------------------------
# MONGO_URI=mongodb://localhost:27017/dyocense
# MONGO_HOST=localhost
# MONGO_PORT=27017
# MONGO_DB_NAME=dyocense
# MONGO_USERNAME=
# MONGO_PASSWORD=

# ---------------------------------------------------------------------
# Server Configuration
# ---------------------------------------------------------------------
HOST=0.0.0.0
PORT=8001
WORKER_COUNT=2
LOG_LEVEL=INFO

# ---------------------------------------------------------------------
# Security (CHANGE THESE IN PRODUCTION!)
# ---------------------------------------------------------------------
# Generate with: openssl rand -base64 32
SECRET_KEY=your_secret_key_here_change_in_production
JWT_SECRET=your_jwt_secret_here_change_in_production

# CORS origins (comma-separated)
CORS_ORIGINS=*

# ---------------------------------------------------------------------
# Performance Tuning
# ---------------------------------------------------------------------
MAX_CONCURRENT_RUNS=10
EVENT_PROCESSING_INTERVAL=1
ORCHESTRATION_INTERVAL=2

# ---------------------------------------------------------------------
# Feature Flags - Core Services
# ---------------------------------------------------------------------
ENABLE_ACCOUNTS_SERVICE=true
ENABLE_CHAT_SERVICE=true

# ---------------------------------------------------------------------
# Feature Flags - Kernel Services
# ---------------------------------------------------------------------
ENABLE_COMPILER_SERVICE=true
ENABLE_FORECAST_SERVICE=true
ENABLE_POLICY_SERVICE=true
ENABLE_OPTIMISER_SERVICE=true
ENABLE_DIAGNOSTICIAN_SERVICE=true
ENABLE_EXPLAINER_SERVICE=true

# ---------------------------------------------------------------------
# Feature Flags - Data & Integration Services
# ---------------------------------------------------------------------
# Connectors currently depend on MongoDB. Disable by default for SMB/Postgres.
ENABLE_CONNECTORS_SERVICE=false
ENABLE_KNOWLEDGE_SERVICE=true
ENABLE_EVIDENCE_SERVICE=true

# ---------------------------------------------------------------------
# Feature Flags - Platform Services
# ---------------------------------------------------------------------
ENABLE_MARKETPLACE_SERVICE=true
ENABLE_SCENARIO_SERVICE=true

# ---------------------------------------------------------------------
# Observability
# ---------------------------------------------------------------------
ENABLE_TELEMETRY=true
ENABLE_METRICS=true

# ---------------------------------------------------------------------
# External Services - Email
# ---------------------------------------------------------------------
ENABLE_EMAIL=true
SENDGRID_API_KEY=your_sendgrid_api_key

# Email sender configuration
EMAIL_FROM=noreply@dyocense.com
EMAIL_FROM_NAME=Dyocense

# ---------------------------------------------------------------------
# External Services - Blob Storage
# ---------------------------------------------------------------------
ENABLE_BLOB_STORAGE=false

# If blob storage enabled, configure:
# AWS_S3_BUCKET=your-bucket-name
# AWS_ACCESS_KEY_ID=your-access-key
# AWS_SECRET_ACCESS_KEY=your-secret-key
# AWS_REGION=us-east-1

# Or Azure Blob:
# AZURE_STORAGE_ACCOUNT=your-account
# AZURE_STORAGE_KEY=your-key
# AZURE_STORAGE_CONTAINER=your-container

# ---------------------------------------------------------------------
# Plan Tier Configuration
# ---------------------------------------------------------------------
DEFAULT_PLAN_TIER=smb_starter

# ---------------------------------------------------------------------
# Monitoring - Grafana (if using monitoring profile)
# ---------------------------------------------------------------------
GRAFANA_USER=admin
GRAFANA_PASSWORD=change_this_secure_password
GRAFANA_PORT=3000

# ---------------------------------------------------------------------
# Production - Nginx (if using production profile)
# ---------------------------------------------------------------------
HTTP_PORT=80
HTTPS_PORT=443

# Domain configuration
# DOMAIN=yourdomain.com
# LETSENCRYPT_EMAIL=admin@yourdomain.com

# ---------------------------------------------------------------------
# Development Settings
# ---------------------------------------------------------------------
# RELOAD=true  # Enable auto-reload for development
# DEBUG=false  # Enable debug mode
# SMTP Email (for invitations and onboarding)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=reddy003@gmail.com
SMTP_PASS=nrdb kmgr ducg gyfu
SMTP_FROM=Dyocense <noreply@dyocense.com>
SMTP_TLS=true

LLM_PROVIDER=azure
OLLAMA_BASE_URL=http://localhost:11434
OLLAMA_MODEL=gpt-4o-mini
ALLOW_ANONYMOUS=true
ACCOUNTS_JWT_SECRET=dyocense-dev-secret

# Optional OpenAI configuration (uncomment to use OpenAI)
# OPENAI_API_KEY=
# OPENAI_MODEL=gpt-4o-mini

# Optional Azure OpenAI configuration (requires azure-ai-openai)
AZURE_OPENAI_ENDPOINT=https://ai-hubwppai326115464401.openai.azure.com
AZURE_OPENAI_API_KEY=8mugTjYozcXx4xf4GWE5KN1jJOG7ptwJvDCJxcO1OLnojZ2vI2NlJQQJ99BHACYeBjFXJ3w3AAAAACOGfPtz
AZURE_OPENAI_DEPLOYMENT=gpt-4o-mini
AZURE_OPENAI_TEMPERATURE=0.0
AZURE_OPENAI_MAX_TOKENS=2048
AZURE_OPENAI_EMBED_DEPLOYMENT=text-embedding-3-small

ENABLE_CONNECTORS_SERVICE=true
OPENAI_API_TYPE=azure
# Connector credential encryption key
CONNECTOR_ENCRYPTION_KEY=QI_yCiLQd_9yK37-TxWObkDopayRzUj-8k3z54ioZrQ=
CONNECTOR_PLAINTEXT=1
CONNECTOR_DEV_DISABLE_AUTH=1
CONNECTOR_ENABLE_ERP_MCP=true

# =====================================================================
# PostgreSQL Configuration for Dyocense v4.0
# =====================================================================
# Purpose: Production-grade settings for TimescaleDB + pgvector
# Image: timescale/timescaledb-ha:pg16
# Target: 2-4 CPU, 4-8GB RAM
# =====================================================================

# =============================================================================
# CONNECTIONS AND AUTHENTICATION
# =============================================================================

max_connections = 200
superuser_reserved_connections = 3

# Connection settings
listen_addresses = '*'
port = 5432

# Authentication
password_encryption = scram-sha-256

# =============================================================================
# RESOURCE USAGE (Optimized for 4GB RAM, 2-4 CPUs)
# =============================================================================

# Memory settings (auto-tuned by timescaledb-tune)
shared_buffers = 1GB
effective_cache_size = 3GB
maintenance_work_mem = 256MB
work_mem = 10MB

# Parallel query settings
max_worker_processes = 8
max_parallel_workers_per_gather = 2
max_parallel_workers = 4
max_parallel_maintenance_workers = 2

# Background workers
max_wal_senders = 10
max_replication_slots = 10

# =============================================================================
# WRITE-AHEAD LOG (WAL)
# =============================================================================

wal_level = replica
wal_compression = on
wal_buffers = 16MB
min_wal_size = 1GB
max_wal_size = 4GB

# Checkpoints
checkpoint_timeout = 10min
checkpoint_completion_target = 0.9
checkpoint_warning = 30s

# Archive mode (for backups)
archive_mode = on
archive_command = '/bin/true'  # Replace with actual backup command

# =============================================================================
# QUERY TUNING
# =============================================================================

# Cost-based query planner
random_page_cost = 1.1  # Optimized for SSD
effective_io_concurrency = 200
seq_page_cost = 1.0

# Query planning
default_statistics_target = 100
constraint_exclusion = partition
cpu_tuple_cost = 0.01
cpu_index_tuple_cost = 0.005
cpu_operator_cost = 0.0025

# =============================================================================
# LOGGING
# =============================================================================

logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_truncate_on_rotation = on

# What to log
log_min_duration_statement = 1000  # Log queries slower than 1s
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_temp_files = 0
log_autovacuum_min_duration = 0
log_error_verbosity = default

# Statement logging
log_statement = 'none'  # Change to 'ddl' or 'all' for debugging
log_duration = off

# =============================================================================
# AUTOVACUUM
# =============================================================================

autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 20s

# Aggressive autovacuum for high-traffic tables
autovacuum_vacuum_threshold = 50
autovacuum_vacuum_scale_factor = 0.02
autovacuum_analyze_threshold = 50
autovacuum_analyze_scale_factor = 0.01

# Autovacuum cost delays (reduce I/O impact)
autovacuum_vacuum_cost_delay = 2ms
autovacuum_vacuum_cost_limit = 200

# =============================================================================
# CLIENT CONNECTION DEFAULTS
# =============================================================================

# Statement behavior
statement_timeout = 300000  # 5 minutes
lock_timeout = 30000  # 30 seconds
idle_in_transaction_session_timeout = 300000  # 5 minutes

# Locale and formatting
datestyle = 'iso, mdy'
timezone = 'UTC'
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'
default_text_search_config = 'pg_catalog.english'

# =============================================================================
# SHARED PRELOAD LIBRARIES
# =============================================================================

shared_preload_libraries = 'timescaledb,pg_stat_statements'
# Add 'pg_cron' when installed: shared_preload_libraries = 'timescaledb,pg_stat_statements,pg_cron'

# =============================================================================
# TIMESCALEDB SETTINGS
# =============================================================================

timescaledb.telemetry_level = off
timescaledb.max_background_workers = 8

# Compression settings
timescaledb.compress_segmentby = ''
timescaledb.compress_orderby = ''

# =============================================================================
# PG_STAT_STATEMENTS (Query Performance Tracking)
# =============================================================================

pg_stat_statements.max = 10000
pg_stat_statements.track = all
pg_stat_statements.track_utility = on
pg_stat_statements.save = on

# =============================================================================
# PGVECTOR SETTINGS
# =============================================================================

# HNSW index settings (tuned for 1536-dim embeddings)
# Default values are usually sufficient
# hnsw.ef_search = 40  # Runtime search quality

# =============================================================================
# SECURITY
# =============================================================================

# SSL (enable in production)
# ssl = on
# ssl_cert_file = '/etc/ssl/certs/server.crt'
# ssl_key_file = '/etc/ssl/private/server.key'
# ssl_ca_file = '/etc/ssl/certs/ca.crt'
# ssl_prefer_server_ciphers = on
# ssl_ciphers = 'HIGH:MEDIUM:+3DES:!aNULL'

# Row-Level Security
row_security = on

# =============================================================================
# REPLICATION (for high availability)
# =============================================================================

# Hot standby
hot_standby = on
hot_standby_feedback = on
max_standby_streaming_delay = 30s

# Replication
synchronous_commit = on
wal_receiver_timeout = 60s
wal_retrieve_retry_interval = 5s

# =============================================================================
# CUSTOM SETTINGS FOR DYOCENSE
# =============================================================================

# Increase JSONB processing
# (already optimized by work_mem and shared_buffers)

# Track I/O timing
track_io_timing = on
track_functions = all
track_activity_query_size = 4096

# =============================================================================
# PERFORMANCE MONITORING
# =============================================================================

shared_preload_libraries = 'timescaledb,pg_stat_statements'
compute_query_id = on
log_executor_stats = off
log_planner_stats = off
log_parser_stats = off
log_statement_stats = off

# =============================================================================
# JIT (Just-In-Time Compilation)
# =============================================================================

jit = on
jit_above_cost = 100000
jit_inline_above_cost = 500000
jit_optimize_above_cost = 500000

# =============================================================================
# V4.0 BACKEND CONFIGURATION
# =============================================================================

# Environment
ENVIRONMENT=development
DEBUG=true
LOG_LEVEL=DEBUG

# Database (v4.0 uses asyncpg)
DATABASE_URL=postgresql+asyncpg://metadata:metadataPass123@localhost:5432/metadata

# Security
SECRET_KEY=dev-secret-key-change-in-production
JWT_ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=1440

# CORS (must be valid JSON array)
CORS_ORIGINS=["http://localhost:3000","http://localhost:5173","http://localhost:5174","http://localhost:5175","http://localhost:5176","http://localhost:5177","http://localhost:5178","http://localhost:8001"]

# LLM Configuration
ENABLE_LOCAL_LLM=true
LOCAL_LLM_URL=http://localhost:11434
LOCAL_LLM_MODEL=llama3:8b

# OpenAI
OPENAI_API_KEY=sk-your-key-here
OPENAI_MODEL=gpt-4o

# Observability
ENABLE_PROMETHEUS=true
ENABLE_TRACING=false
OTEL_SERVICE_NAME=dyocense-backend
OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4318

# Logging
LOG_JSON_FORMAT=false

# Feature Flags
ENABLE_CACHING=false
ENABLE_STREAMING=true
ENABLE_BENCHMARKING=true
